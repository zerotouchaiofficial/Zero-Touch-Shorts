name: ðŸŽ¬ Daily YouTube Shorts Generator

on:
  schedule:
    - cron: '0 0  * * *'
    - cron: '0 2  * * *'
    - cron: '0 4  * * *'
    - cron: '0 6  * * *'
    - cron: '0 8  * * *'
    - cron: '0 10 * * *'
    - cron: '0 12 * * *'
    - cron: '0 14 * * *'
    - cron: '0 16 * * *'
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: write

    steps:

    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ðŸ“¦ Install system packages
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          imagemagick ffmpeg \
          fonts-dejavu-core \
          fonts-liberation \
          python3-dev
        sudo mv /etc/ImageMagick-6/policy.xml \
                /etc/ImageMagick-6/policy.xml.bak || true

    - name: ðŸ Install Python packages
      run: pip install -r requirements.txt

    - name: ðŸ”¢ Set video number
      id: vidnum
      run: |
        VID_NUM=$(date +'%Y%m%d%H')
        echo "video_number=$VID_NUM" >> $GITHUB_OUTPUT
        echo "Video number: $VID_NUM"

    - name: ðŸŽ¬ Generate Short + Thumbnail
      env:
        UNSPLASH_KEY: ${{ secrets.UNSPLASH_KEY }}
      run: |
        python - <<'PYEOF'
        import sys, json
        sys.path.insert(0, '.')
        from scripts.generate_short import generate

        vid, thumb, facts = generate(${{ steps.vidnum.outputs.video_number }})

        with open('output_paths.txt', 'w') as f:
            f.write(vid   + '\n')
            f.write((thumb or '') + '\n')

        print(f'VIDEO : {vid}')
        print(f'THUMB : {thumb}')
        print(f'FACTS : {len(facts)}')
        PYEOF

    - name: ðŸ“¤ Upload to YouTube
      env:
        YT_CLIENT_ID:     ${{ secrets.YT_CLIENT_ID }}
        YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
        YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      run: |
        python - <<'PYEOF'
        import sys, os, json
        sys.path.insert(0, '.')

        with open('output_paths.txt') as f:
            lines      = f.read().strip().split('\n')
        vid_path   = lines[0]
        thumb_path = lines[1] if len(lines) > 1 and lines[1] else None

        facts_file = vid_path.replace('/short.mp4', '/facts.json')
        with open(facts_file) as f:
            facts = json.load(f)

        from scripts.upload_youtube import upload_video

        vid_id, url = upload_video(
            video_path   = vid_path,
            facts        = facts,
            video_number = int('${{ steps.vidnum.outputs.video_number }}'),
            thumb_path   = thumb_path,
        )
        print(f'âœ… Uploaded: {url}')
        PYEOF

    - name: ðŸ’¾ Commit used_facts.json back to repo
      if: always()
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add used_facts.json || true
        git diff --cached --quiet || \
          git commit -m "ðŸ¤– Update used_facts.json [skip ci]"
        git push || true

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        rm -rf output/ _audio/ _images/ || true
        echo "âœ… Cleaned up"
